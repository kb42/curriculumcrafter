name: Deployment Check

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  check-backend-deployment:
    name: Check Backend Deployment Config
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Render configuration
        run: |
          echo "Checking Render deployment files..."
          if [ -f "react-flask/flask-server/render.yaml" ]; then
            echo "✓ render.yaml found"
            cat react-flask/flask-server/render.yaml
          else
            echo "✗ render.yaml not found"
            exit 1
          fi

      - name: Verify requirements.txt
        run: |
          echo "Checking Python dependencies..."
          if [ -f "react-flask/flask-server/requirements.txt" ]; then
            echo "✓ requirements.txt found"
            cat react-flask/flask-server/requirements.txt

            # Check for required packages
            required_packages=("Flask" "gunicorn" "PyMySQL" "Flask-JWT-Extended")
            for package in "${required_packages[@]}"; do
              if grep -qi "$package" react-flask/flask-server/requirements.txt; then
                echo "✓ $package found"
              else
                echo "✗ $package missing"
                exit 1
              fi
            done
          else
            echo "✗ requirements.txt not found"
            exit 1
          fi

      - name: Verify environment example
        run: |
          echo "Checking environment configuration..."
          if [ -f "react-flask/flask-server/.env.example" ]; then
            echo "✓ .env.example found"
            cat react-flask/flask-server/.env.example
          else
            echo "Warning: .env.example not found"
          fi

  check-frontend-deployment:
    name: Check Frontend Deployment Config
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Netlify configuration
        run: |
          echo "Checking Netlify deployment files..."
          if [ -f "react-flask/client-side/netlify.toml" ]; then
            echo "✓ netlify.toml found"
            cat react-flask/client-side/netlify.toml
          else
            echo "✗ netlify.toml not found"
            exit 1
          fi

      - name: Check API URL configuration
        run: |
          echo "Verifying API URL is set in netlify.toml..."
          if grep -q "REACT_APP_API_URL" react-flask/client-side/netlify.toml 2>/dev/null; then
            echo "✓ API URL configured in netlify.toml"
            grep "REACT_APP_API_URL" react-flask/client-side/netlify.toml
          else
            echo "✗ API URL not found in netlify.toml"
            exit 1
          fi

  verify-no-secrets:
    name: Verify No Secrets Committed
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for .env files in git
        run: |
          echo "Checking for committed .env files..."
          if git ls-files | grep -E "\.env$" | grep -v "\.env\.example\|\.env\.production"; then
            echo "✗ ERROR: .env file found in git!"
            echo "The following .env files should not be committed:"
            git ls-files | grep -E "\.env$" | grep -v "\.env\.example\|\.env\.production"
            exit 1
          else
            echo "✓ No sensitive .env files committed"
          fi

      - name: Check for hardcoded credentials
        run: |
          echo "Checking for potential hardcoded credentials..."

          # Check for literal hardcoded passwords (not variable assignments)
          if grep -r -i "password\s*=\s*['\"][^{$].*['\"]" --include="*.py" --include="*.js" react-flask/ | grep -v "PasswordHash\|password_hash\|getenv\|process.env"; then
            echo "Warning: Potential hardcoded passwords found"
          else
            echo "✓ No obvious hardcoded passwords"
          fi

          # Check for hardcoded database URLs (not f-strings or env vars)
          if grep -r "mysql://[^{$\"'].*:.*@" --include="*.py" --include="*.js" react-flask/; then
            echo "✗ ERROR: Hardcoded database connection string found"
            exit 1
          else
            echo "✓ No hardcoded database credentials"
          fi

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [check-backend-deployment, check-frontend-deployment, verify-no-secrets]

    steps:
      - name: Summary
        run: |
          echo "========================================="
          echo "Deployment Configuration Check Complete"
          echo "========================================="
          echo "✓ Backend (Render) configuration verified"
          echo "✓ Frontend (Netlify) configuration verified"
          echo "✓ No secrets committed to repository"
          echo ""
          echo "Ready for deployment!"