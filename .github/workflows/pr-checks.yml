name: Pull Request Checks

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

jobs:
  pr-validation:
    name: Validate Pull Request
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $PR_TITLE"

          # Check if title is descriptive (more than 10 characters)
          if [ ${#PR_TITLE} -lt 10 ]; then
            echo "✗ PR title too short. Please provide a descriptive title."
            exit 1
          else
            echo "✓ PR title is descriptive"
          fi

      - name: Check for large files
        run: |
          echo "Checking for large files..."
          large_files=$(find . -type f -size +5M -not -path "*/node_modules/*" -not -path "*/.git/*" -not -path "*/venv/*")

          if [ -n "$large_files" ]; then
            echo "✗ WARNING: Large files detected:"
            echo "$large_files"
            echo "Consider using Git LFS for files larger than 5MB"
          else
            echo "✓ No large files detected"
          fi

      - name: Check for merge conflicts
        run: |
          echo "Checking for merge conflict markers..."
          if grep -r "<<<<<<< HEAD\|=======\|>>>>>>>" --include="*.py" --include="*.js" --include="*.jsx" --include="*.css" .; then
            echo "✗ ERROR: Merge conflict markers found!"
            exit 1
          else
            echo "✓ No merge conflicts detected"
          fi

      - name: Count changed files
        run: |
          echo "Analyzing changes..."
          changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | wc -l)
          echo "Files changed: $changed_files"

          if [ $changed_files -gt 50 ]; then
            echo "⚠ Warning: Large PR with $changed_files files. Consider breaking into smaller PRs."
          else
            echo "✓ Reasonable PR size"
          fi

      - name: Check file permissions
        run: |
          echo "Checking for executable files..."
          executable_files=$(find react-flask/ -type f -executable -not -path "*/node_modules/*" -not -path "*/venv/*" -not -path "*/.git/*" 2>/dev/null || true)

          if [ -n "$executable_files" ]; then
            echo "Executable files found:"
            echo "$executable_files"
          else
            echo "✓ No unexpected executable files"
          fi

  changes-summary:
    name: Changes Summary
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate file change summary
        run: |
          echo "=== Pull Request Changes Summary ==="
          echo ""
          echo "Frontend changes:"
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep "react-flask/client-side" || echo "None"
          echo ""
          echo "Backend changes:"
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep "react-flask/flask-server" || echo "None"
          echo ""
          echo "Configuration changes:"
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E "\.yml$|\.toml$|\.env" || echo "None"
          echo ""
          echo "Documentation changes:"
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E "\.md$" || echo "None"

  auto-label:
    name: Auto Label PR
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Label based on changed files
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const labels = new Set();

            files.forEach(file => {
              if (file.filename.includes('react-flask/client-side')) {
                labels.add('frontend');
              }
              if (file.filename.includes('react-flask/flask-server')) {
                labels.add('backend');
              }
              if (file.filename.includes('.github/workflows')) {
                labels.add('ci/cd');
              }
              if (file.filename.endsWith('.md')) {
                labels.add('documentation');
              }
              if (file.filename.includes('test')) {
                labels.add('tests');
              }
            });

            if (labels.size > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: Array.from(labels)
              });
            }